{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST - Advanced Deepfake Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-dark: #0f172a;
            --secondary-dark: #1e293b;
            --accent-blue: #6366f1;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-cyan: #06b6d4;
            --text-light: #f8fafc;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark), #1a2238);
            color: var(--text-light);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* Premium Button Styles */
        .premium-btn {
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .premium-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .premium-btn:hover:before {
            left: 100%;
        }

        .premium-control-btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .premium-analyze-btn {
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.3);
            border: 2px solid rgba(34, 197, 94, 0.3);
        }

        .premium-analyze-btn:hover {
            box-shadow: 0 12px 40px rgba(34, 197, 94, 0.4);
        }

        /* Floating Animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Pulse Animation */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 211, 238, 0.4); }
            50% { box-shadow: 0 0 40px rgba(34, 211, 238, 0.8); }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Recording Indicator */
        .recording-indicator {
            background: rgba(239, 68, 68, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .pulse-ring {
            width: 12px;
            height: 12px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            animation: pulse-ring 1.5s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* File Upload Animation */
        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(139, 92, 246, 0.05);
        }

        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }

        .hacker-text {
            font-family: 'Montserrat', sans-serif;
            text-shadow: 0 0 8px var(--accent-cyan);
        }

        .glitch {
            position: relative;
        }

        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
        }

        .glitch::before {
            left: 2px;
            text-shadow: -2px 0 #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -2px 0 #00fff9, 2px 2px #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); }
            10% { clip: rect(112px, 9999px, 76px, 0); }
            20% { clip: rect(85px, 9999px, 77px, 0); }
            30% { clip: rect(27px, 9999px, 97px, 0); }
            40% { clip: rect(64px, 9999px, 98px, 0); }
            50% { clip: rect(61px, 9999px, 85px, 0); }
            60% { clip: rect(99px, 9999px, 114px, 0); }
            70% { clip: rect(34px, 9999px, 115px, 0); }
            80% { clip: rect(98px, 9999px, 129px, 0); }
            90% { clip: rect(43px, 9999px, 96px, 0); }
            100% { clip: rect(82px, 9999px, 64px, 0); }
        }

        @keyframes glitch-anim2 {
            0% { clip: rect(65px, 9999px, 119px, 0); }
            10% { clip: rect(66px, 9999px, 72px, 0); }
            20% { clip: rect(112px, 9999px, 59px, 0); }
            30% { clip: rect(91px, 9999px, 29px, 0); }
            40% { clip: rect(20px, 9999px, 28px, 0); }
            50% { clip: rect(50px, 9999px, 69px, 0); }
            60% { clip: rect(78px, 9999px, 40px, 0); }
            70% { clip: rect(102px, 9999px, 68px, 0); }
            80% { clip: rect(105px, 9999px, 84px, 0); }
            90% { clip: rect(15px, 9999px, 100px, 0); }
            100% { clip: rect(64px, 9999px, 44px, 0); }
        }

        .terminal {
            background-color: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--accent-cyan);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }

        .terminal:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.6);
        }

        .terminal::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: linear-gradient(90deg, #ff00c1, #6366f1, #06b6d4, #10b981);
            background-size: 200% 200%;
            animation: gradient 5s ease infinite;
            border-radius: 10px 10px 0 0;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .btn-hover-effect-1:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-hover-effect-2:hover {
            transform: skewX(-10deg);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.5);
        }

        .btn-hover-effect-3:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.7);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .cursor-trail {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent-cyan);
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: screen;
            opacity: 0.7;
            transform: translate(-50%, -50%);
        }

        /* Analysis result animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Video container */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: linear-gradient(45deg, #0f172a, #1e293b);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #1e293b;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* Screen recording indicator */
        .recording-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            animation: pulse 1.5s infinite;
        }
        
        .chart-container {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            padding: 15px;
            height: 250px;
            backdrop-filter: blur(10px);
        }

        .grid-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(99, 102, 241, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }

        .gif-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            height: 200px;
            background: linear-gradient(45deg, #1e293b, #0f172a);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gif-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .feature-card {
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .feature-card:hover {
            transform: scale(1.05) rotate(2deg);
        }

        .tech-badge {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.4);
            border-radius: 20px;
            padding: 5px 15px;
            display: inline-block;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .tech-badge:hover {
            background: rgba(99, 102, 241, 0.4);
            transform: translateY(-3px);
        }

        .pulse-ring {
            display: block;
            width: 10px;
            height: 10px;
            background-color: #10b981;
            border-radius: 50%;
            position: relative;
        }

        .pulse-ring:before {
            content: '';
            display: block;
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background-color: #10b981;
            opacity: 0.4;
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.5); opacity: 0.7; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* Premium History Cards */
        .premium-history-card {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.9) 100%);
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .premium-history-card:hover {
            border-color: rgba(168, 85, 247, 0.4);
            transform: translateY(-2px);
            box-shadow: 
                0 10px 25px -5px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(168, 85, 247, 0.15);
        }
        
        .premium-history-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.6s;
        }
        
        .premium-history-card:hover::before {
            left: 100%;
        }

        /* Enhanced Button Styles */
        .premium-analyze-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .premium-analyze-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%);
            box-shadow: 
                0 20px 40px -10px rgba(16, 185, 129, 0.4),
                0 0 60px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .premium-analyze-btn:active {
            transform: scale(0.98);
        }
        
        /* Glowing Border Animation */
        @keyframes glow-border {
            0%, 100% { border-color: rgba(99, 102, 241, 0.5); }
            50% { border-color: rgba(168, 85, 247, 0.8); }
        }
        
        .glow-border {
            animation: glow-border 2s ease-in-out infinite;
        }
        
        /* Premium Progress Bar */
        .premium-progress {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
            border-radius: 10px;
            height: 6px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .premium-progress::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Enhanced Fade-in Animation for Detection Parameters */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Pulse animation for risk indicators */
        .risk-high {
            animation: pulseRed 2s ease-in-out infinite;
        }
        
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        }
    </style>
</head>
<body class="dark-mode">
    {% csrf_token %}
    <!-- Premium Header -->
    {% include 'partials/header.html' %}
    
    <!-- Cursor Trail -->
    <div id="cursor-trail"></div>
    
    <!-- Screen recording indicator (hidden by default) -->
    <div id="recordingIndicator" class="recording-indicator hidden">
        <span class="pulse-ring mr-2"></span> Recording Screen...
    </div>

    <!-- Main Content -->
    <main class="pt-32 pb-20 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <!-- Hidden CSRF Token -->
        {% csrf_token %}
        
        <!-- Feature Header -->
        <section class="mb-16 text-center">
            <div class="terminal p-8 rounded-lg mb-8 relative overflow-hidden">
                <div class="grid-pattern"></div>
                <h1 class="text-4xl md:text-5xl font-bold mb-4 hacker-text">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-400">Deepfake Detection</span>
                </h1>
                <p class="text-xl text-gray-300 max-w-3xl mx-auto mb-6">
                    Advanced AI analyzes videos in real-time to detect manipulated content with 98.7% accuracy
                </p>
                <div class="flex justify-center space-x-4">
                    <div class="bg-indigo-900/30 px-4 py-2 rounded-full text-indigo-300">
                        <i class="fas fa-bolt mr-2"></i> Real-time Analysis
                    </div>
                    <div class="bg-cyan-900/30 px-4 py-2 rounded-full text-cyan-300">
                        <i class="fas fa-shield-alt mr-2"></i> 256-bit Encryption
                    </div>
                </div>
            </div>
        </section>

        <!-- Detection Interface -->
        <section class="mb-20">
            <div class="terminal p-6 rounded-lg">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Video Input Section -->
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-video mr-3 text-cyan-400"></i> Upload or Record Video
                        </h2>
                                                
                        <div class="video-container mb-6" id="videoContainer">
                            <video id="videoPreview" class="hidden" autoplay muted></video>
                            <div class="absolute inset-0 flex items-center justify-center" id="videoPlaceholder">
                                <div class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-600 mb-2"></i>
                                    <p class="text-gray-500">Upload or record a video to analyze</p>
                                </div>
                            </div>
                        </div>
                                                
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <button id="recordBtn" class="premium-btn relative bg-gradient-to-r from-cyan-500 via-blue-600 to-indigo-600 hover:from-cyan-600 hover:via-blue-700 hover:to-indigo-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-cyan-500/25 flex-1 flex items-center justify-center group overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-cyan-400/20 to-blue-400/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                <i class="fas fa-video mr-3 text-xl group-hover:animate-pulse relative z-10"></i> 
                                <span class="text-lg relative z-10">Record Screen</span>
                                <div class="absolute inset-0 bg-white/10 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                            </button>
                            <button id="uploadBtn" class="premium-btn relative bg-gradient-to-r from-purple-600 via-purple-700 to-indigo-700 hover:from-purple-700 hover:via-purple-800 hover:to-indigo-800 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/25 flex-1 flex items-center justify-center group overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-purple-400/20 to-indigo-400/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                <i class="fas fa-cloud-upload-alt mr-3 text-xl group-hover:animate-bounce relative z-10"></i> 
                                <span class="text-lg relative z-10">Upload File</span>
                                <div class="absolute inset-0 bg-white/10 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                            </button>
                            <input type="file" id="videoInput" accept="image/*,video/*,.jpg,.jpeg,.png,.gif,.bmp,.mp4,.avi,.mov,.webm" class="hidden">
                        </div>
                                                
                        <div class="bg-gradient-to-r from-gray-800/90 to-gray-900/90 backdrop-blur-sm p-6 rounded-2xl mb-6 hidden border border-gray-700/50" id="recordingControls">
                            <div class="flex justify-center space-x-6">
                                <button id="startRecording" class="premium-control-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-lg hover:shadow-red-500/25 flex items-center group">
                                    <i class="fas fa-circle mr-2 text-sm group-hover:animate-pulse"></i> 
                                    <span>Start Recording</span>
                                </button>
                                <button id="stopRecording" class="premium-control-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center" disabled>
                                    <i class="fas fa-stop mr-2"></i> 
                                    <span>Stop Recording</span>
                                </button>
                                <button id="cancelRecording" class="premium-control-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-lg hover:shadow-orange-500/25 flex items-center">
                                    <i class="fas fa-times mr-2"></i> 
                                    <span>Cancel</span>
                                </button>
                            </div>
                            <div class="mt-4 text-center">
                                <div class="text-2xl font-mono text-cyan-400 font-bold" id="recordingTime">00:00</div>
                                <div class="text-sm text-gray-400 mt-1">Recording Duration</div>
                            </div>
                        </div>
                    </div>
                                        
                    <!-- Analysis Section -->
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-chart-line mr-3 text-green-400"></i> Analysis Results
                        </h2>
                                                
                        <div class="bg-gray-800/50 rounded-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">Detection Status</h3>
                                <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded" id="statusText">READY</span>
                            </div>
                                                        
                            <div class="progress-container mb-6">
                                <div class="progress-bar" id="progressBar"></div>
                            </div>
                                                        
                            <div class="hidden" id="loadingIndicator">
                                <div class="flex flex-col items-center justify-center py-8">
                                    <div class="spinner mb-4"></div>
                                    <p class="text-gray-400 font-semibold mb-3">Analyzing video content with AI...</p>
                                    
                                    <!-- Detailed Analysis Steps -->
                                    <div class="space-y-2 text-center">
                                        <div class="text-cyan-400 text-sm" id="analysisStep">🔍 Initializing neural networks...</div>
                                        <div class="text-gray-500 text-xs">Advanced detection pipeline active</div>
                                    </div>
                                    
                                    <!-- Analysis Progress Steps -->
                                    <div class="mt-4 grid grid-cols-2 gap-3 text-xs">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                            <span class="text-gray-400">Facial Analysis</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                                            <span class="text-gray-400">Texture Scan</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                                            <span class="text-gray-400">Audio-Visual</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse" style="animation-delay: 0.6s;"></div>
                                            <span class="text-gray-400">Spectral Check</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                        
                            <div class="hidden" id="resultsContainer">
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="bg-gray-900/50 p-4 rounded-lg">
                                        <p class="text-gray-400 text-sm mb-1">Deepfake Probability</p>
                                        <p class="text-3xl font-bold" id="deepfakeScore">--%</p>
                                    </div>
                                    <div class="bg-gray-900/50 p-4 rounded-lg">
                                        <p class="text-gray-400 text-sm mb-1">Confidence Level</p>
                                        <p class="text-3xl font-bold" id="confidenceScore">--%</p>
                                    </div>
                                </div>
                                                                
                                <div class="mb-6">
                                    <p class="text-gray-400 text-sm mb-2">Detection Details</p>
                                    <div class="bg-gray-900/50 p-4 rounded-lg">
                                        <p class="text-white" id="detectionDetails">No analysis performed yet.</p>
                                    </div>
                                </div>
                                                                
                                <div class="mb-6">
                                    <p class="text-gray-400 text-sm mb-2">Manipulation Indicators</p>
                                    <div class="space-y-2" id="indicatorsList">
                                        <!-- Indicators will be added here dynamically -->
                                    </div>
                                </div>

                                <!-- Charts Section -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                                    <div class="chart-container">
                                        <canvas id="barChart"></canvas>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="pieChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Download Report Button -->
                                <div class="mt-8 text-center">
                                    <button id="downloadReportBtn" class="premium-btn bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 hover:from-blue-700 hover:via-purple-700 hover:to-indigo-700 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-blue-500/25 group overflow-hidden hidden">
                                        <div class="absolute inset-0 bg-gradient-to-r from-blue-400/20 to-indigo-400/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        <div class="relative z-10 flex items-center justify-center">
                                            <i class="fas fa-download mr-3 text-xl group-hover:animate-bounce"></i> 
                                            <span>Download Analysis Report</span>
                                            <i class="fas fa-file-pdf ml-3 text-lg"></i>
                                        </div>
                                        <div class="absolute inset-0 bg-white/10 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                                                
                        <button id="analyzeBtn" class="premium-analyze-btn relative bg-gradient-to-r from-emerald-500 via-green-600 to-teal-600 hover:from-emerald-600 hover:via-green-700 hover:to-teal-700 text-white w-full py-4 rounded-2xl font-bold text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl hover:shadow-green-500/25 hidden group overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-400/20 to-teal-400/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="relative z-10 flex items-center justify-center">
                                <i class="fas fa-brain mr-3 text-xl group-hover:animate-pulse"></i> 
                                <span>Analyze with AI</span>
                                <i class="fas fa-magic ml-3 text-lg group-hover:animate-bounce"></i>
                            </div>
                            <div class="absolute inset-0 bg-white/10 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                        </button>
                        
                        <!-- View History Button -->
                        <div class="mt-4 text-center">
                            <a href="{% url 'history' %}" class="inline-flex items-center bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-history mr-2"></i> View Full Analysis History
                            </a>
                        </div>
                        
                        <!-- Enhanced Recent History Section -->
                        <div class="mt-12">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                                <i class="fas fa-clock mr-3 text-purple-400"></i> Recent Analyses
                            </h3>
                            
                            <div id="historySection" class="hidden">
                                <div id="historyContent" class="space-y-4">
                                    <!-- History will be populated here by JavaScript -->
                                </div>
                            </div>
                            
                            <div id="noHistoryMessage" class="text-center py-8 text-gray-400">
                                <i class="fas fa-inbox text-3xl mb-3 opacity-50"></i>
                                <p class="text-sm">No recent analyses</p>
                                <p class="text-xs text-gray-500">Upload or record media to see detection history</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
                
        <!-- How It Works -->
        <section class="mb-20">
            <div class="terminal p-8 rounded-lg">
                <h2 class="text-3xl font-bold text-white mb-8 text-center hacker-text">
                    How Our Deepfake Detection Works
                </h2>
                                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-gray-800/50 p-6 rounded-lg feature-card">
                        <div class="flex justify-center mb-4">
                            <div class="gif-container">
                                <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExa2I4bWZ0c3R0d2x0cGg4Y3VvN3I3M3J6N3k2ZHFqZ3J5NWR0dW5wbiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7btT1T9qpQZWhNlK/giphy.gif" alt="Neural Network Analysis">
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white text-center mb-3">Neural Network Analysis</h3>
                        <p class="text-gray-400 text-center">
                            Our AI examines facial micro-expressions, blinking patterns, and unnatural movements that are telltale signs of deepfakes.
                        </p>
                    </div>
                                        
                    <div class="bg-gray-800/50 p-6 rounded-lg feature-card">
                        <div class="flex justify-center mb-4">
                            <div class="gif-container">
                                <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExMWF5ZzY4dHZ1bTd6cXh0dG5rZXFrc2V6cHk0cG5jbzZ3a3BqZnB4eiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o6Zt481isNVuQI1l6/giphy.gif" alt="Spectral Analysis">
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white text-center mb-3">Spectral Analysis</h3>
                        <p class="text-gray-400 text-center">
                            We analyze the video's frequency spectrum for inconsistencies that indicate manipulation or generation artifacts.
                        </p>
                    </div>
                                        
                    <div class="bg-gray-800/50 p-6 rounded-lg feature-card">
                        <div class="flex justify-center mb-4">
                            <div class="gif-container">
                                <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExa3N5a2NvZ2p4YzBzYjY0eXQ4dXl6bGZxYzJ0dHZvb3d0Z3l3dGZ5dCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xT0xezQGU8x2gWnOj6/giphy.gif" alt="Ensemble Verification">
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white text-center mb-3">Ensemble Verification</h3>
                        <p class="text-gray-400 text-center">
                            Multiple specialized models vote on authenticity, with our proprietary algorithm combining their insights.
                        </p>
                    </div>
                </div>
            </div>
        </section>
                
        <!-- Analytics Dashboard -->
        <section class="mb-20">
            <div class="terminal p-8 rounded-lg">
                <h2 class="text-3xl font-bold text-white mb-8 text-center hacker-text">
                    Deepfake Detection Analytics
                </h2>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-cyan-400"></i> Detection Accuracy
                        </h3>
                        <div class="chart-container">
                            <canvas id="accuracyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-wave-square mr-2 text-indigo-400"></i> Performance Metrics
                        </h3>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-bug mr-2 text-red-400"></i> Threat Analysis
                        </h3>
                        <div class="chart-container">
                            <canvas id="threatChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i class="fas fa-clock mr-2 text-yellow-400"></i> Response Times
                        </h3>
                        <div class="chart-container">
                            <canvas id="responseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>
                
        <!-- Tech Stack -->
        <section class="mb-20">
            <div class="terminal p-8 rounded-lg">
                <h2 class="text-3xl font-bold text-white mb-8 text-center hacker-text">
                    Technology Stack
                </h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                    <div class="tech-badge">
                        <i class="fab fa-python text-2xl text-blue-400 mb-2"></i>
                        <p class="font-medium">Python</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-brain text-2xl text-indigo-400 mb-2"></i>
                        <p class="font-medium">TensorFlow</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-project-diagram text-2xl text-purple-400 mb-2"></i>
                        <p class="font-medium">Neural Nets</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-eye text-2xl text-cyan-400 mb-2"></i>
                        <p class="font-medium">Computer Vision</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-cloud text-2xl text-blue-300 mb-2"></i>
                        <p class="font-medium">Cloud AI</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-shield-alt text-2xl text-green-400 mb-2"></i>
                        <p class="font-medium">Encryption</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-bolt text-2xl text-yellow-400 mb-2"></i>
                        <p class="font-medium">Real-time</p>
                    </div>
                    <div class="tech-badge">
                        <i class="fas fa-dna text-2xl text-red-400 mb-2"></i>
                        <p class="font-medium">GAN Analysis</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900/90 backdrop-blur-md border-t border-gray-800">
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-ghost mr-2 text-cyan-400"></i> GHOST
                    </h3>
                    <p class="text-gray-400 text-sm">
                        Advanced AI-driven identity verification protecting against deepfakes and synthetic media.
                    </p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Home</a></li>
                        <li><a href="index.html#features" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Features</a></li>
                        <li><a href="index.html#tech" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Technology</a></li>
                        <li><a href="index.html#demo" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Demo</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Resources</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Documentation</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">API Reference</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Blog</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Support</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Legal</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Privacy Policy</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Terms of Service</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Security</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white text-sm transition-all duration-300">Compliance</a></li>
                    </ul>
                </div>
            </div>
            <div class="mt-12 pt-8 border-t border-gray-800 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-500 text-sm mb-4 md:mb-0">
                    © 2023 GHOST Security. All rights reserved.
                </p>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-500 hover:text-white transition-all duration-300">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-500 hover:text-white transition-all duration-300">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a href="#" class="text-gray-500 hover:text-white transition-all duration-300">
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="#" class="text-gray-500 hover:text-white transition-all duration-300">
                        <i class="fab fa-discord"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let mediaRecorder;
        let recordedChunks = [];
        let currentLogId = null;
        let isRecording = false;
        let recordingTimer = null;
        let recordingStartTime = null;
        let screenStream = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing...');
            
            // Check browser support for screen recording
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                console.error('Screen recording not supported in this browser');
                showNotification('⚠️ Screen recording is not supported in this browser. Please use Chrome, Firefox, or Edge.', 'warning', 10000);
                
                // Disable record button
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.disabled = true;
                    recordBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-3"></i>Not Supported';
                    recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // Check if all required elements exist
            const requiredElements = [
                'videoInput', 'uploadBtn', 'recordBtn', 'analyzeBtn', 
                'videoPreview', 'videoPlaceholder', 'recordingControls',
                'startRecording', 'stopRecording', 'cancelRecording'
            ];
            
            requiredElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`✓ Element found: ${id}`);
                } else {
                    console.error(`✗ Element missing: ${id}`);
                }
            });
            
            // Initialize tooltips and animations
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 800,
                    once: true
                });
            }

            // Initialize charts
            initCharts();

            // Load detection history
            loadDetectionHistory();

            // Set up event listeners
            setupEventListeners();
            
            // Initialize analyze button as disabled
            disableAnalyzeButton();
            
            console.log('Initialization complete');
        });

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Get file input reference once
            const fileInput = document.getElementById('videoInput');
            
            // File upload
            if (fileInput) {
                console.log('File input found, adding event listener');
                fileInput.addEventListener('change', handleFileUpload);
            } else {
                console.error('File input not found!');
            }
            
            // Upload button
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn && fileInput) {
                console.log('Upload button found, adding event listener');
                uploadBtn.addEventListener('click', () => {
                    console.log('Upload button clicked');
                    fileInput.click(); // Trigger file input
                });
            } else {
                console.error('Upload button or file input not found!');
                console.log('Upload button:', uploadBtn);
                console.log('File input:', fileInput);
            }
            
            // Record screen button
            const recordBtn = document.getElementById('recordBtn');
            if (recordBtn) {
                console.log('Record button found, adding event listener');
                recordBtn.addEventListener('click', () => {
                    console.log('Record button clicked - starting screen recording');
                    startScreenRecording(); // Directly start screen recording
                });
            } else {
                console.error('Record button not found!');
            }
            
            // Analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                console.log('Analyze button found, adding event listener');
                analyzeBtn.addEventListener('click', analyzeMedia);
            } else {
                console.error('Analyze button not found!');
            }
            
            // Download Report button
            const downloadReportBtn = document.getElementById('downloadReportBtn');
            if (downloadReportBtn) {
                console.log('Download report button found, adding event listener');
                downloadReportBtn.addEventListener('click', downloadAnalysisReport);
            } else {
                console.error('Download report button not found!');
            }
            
            // Recording controls
            const startRecording = document.getElementById('startRecording');
            const stopRecording = document.getElementById('stopRecording');
            const cancelRecording = document.getElementById('cancelRecording');
            
            if (startRecording) {
                startRecording.addEventListener('click', startScreenRecording);
            }
            if (stopRecording) {
                stopRecording.addEventListener('click', stopScreenRecording);
            }
            if (cancelRecording) {
                cancelRecording.addEventListener('click', cancelScreenRecording);
            }

            // Mobile menu toggle
            const mobileMenuButton = document.querySelector('button[aria-controls="mobile-menu"]');
            const mobileMenu = document.getElementById('mobile-menu');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            const themeToggleMobile = document.getElementById('theme-toggle-mobile');
            const body = document.body;

            const themes = ['dark-mode', 'light-mode', 'default-mode'];
            const themeNames = ['Dark', 'Light', 'Default'];
            let currentThemeIndex = 0;

            function setTheme(index) {
                // Remove all theme classes
                body.classList.remove(...themes);
                            
                // Add the selected theme class
                body.classList.add(themes[index]);
                            
                // Update button text
                const themeName = themeNames[index];
                const iconClass = index === 0 ? 'fa-moon' : index === 1 ? 'fa-sun' : 'fa-adjust';
                            
                if (themeToggle) {
                    themeToggle.innerHTML = `<i class="fas ${iconClass} mr-1"></i> ${themeName}`;
                }
                            
                if (themeToggleMobile) {
                    themeToggleMobile.innerHTML = `<i class="fas ${iconClass} mr-1"></i> ${themeName}`;
                }
                            
                // Update current theme index
                currentThemeIndex = index;
            }

            function cycleTheme() {
                const nextThemeIndex = (currentThemeIndex + 1) % themes.length;
                setTheme(nextThemeIndex);
            }

            if (themeToggle) {
                themeToggle.addEventListener('click', cycleTheme);
            }

            if (themeToggleMobile) {
                themeToggleMobile.addEventListener('click', cycleTheme);
            }

            // Initialize theme
            setTheme(0);

            // Cursor trail effect
            const cursorTrail = document.getElementById('cursor-trail');
            let mouseX = 0, mouseY = 0;
            let trailX = 0, trailY = 0;
            const speed = 0.2;

            if (cursorTrail) {
                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });

                function animateCursorTrail() {
                    const dx = mouseX - trailX;
                    const dy = mouseY - trailY;
                                
                    trailX += dx * speed;
                    trailY += dy * speed;
                                
                    cursorTrail.style.left = trailX + 'px';
                    cursorTrail.style.top = trailY + 'px';
                                
                    requestAnimationFrame(animateCursorTrail);
                }

                animateCursorTrail();
            }
        }

        async function handleFileUpload(event) {
            console.log('handleFileUpload called', event);
            const file = event.target.files[0];
            console.log('Selected file:', file);
            
            if (!file) {
                console.log('No file selected');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'video/mp4', 'video/avi', 'video/mov', 'video/webm'];
            console.log('File type:', file.type);
            
            if (!allowedTypes.includes(file.type)) {
                console.error('Invalid file type:', file.type);
                showNotification('Please select a valid image or video file', 'error');
                return;
            }

            console.log('File validation passed, starting upload...');
            showLoadingState('Uploading file...', true);

            try {
                const formData = new FormData();
                formData.append('file', file);  // Backend expects 'file'
                formData.append('source_type', 'upload');
                formData.append('csrfmiddlewaretoken', getCSRFToken());

                const response = await fetch('/api/upload-deepfake-media/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                console.log('Upload response:', data);

                if (data.success) {
                    currentLogId = data.log_id;
                    displayUploadedFile(file, data.file_type);
                    enableAnalyzeButton();
                    updateStatusText('READY', 'ready');
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error || 'Upload failed', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Upload failed. Please try again.', 'error');
            } finally {
                showLoadingState('', false);
            }
        }

        async function toggleScreenRecording() {
            const recordingControls = document.getElementById('recordingControls');
            const recordBtn = document.getElementById('recordBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (recordingControls && recordBtn && uploadBtn) {
                recordingControls.classList.remove('hidden');
                recordBtn.disabled = true;
                uploadBtn.disabled = true;
            }
        }

        async function startScreenRecording() {
            try {
                console.log('Starting screen recording...');
                
                // Show user-friendly notification
                showNotification('🎥 Requesting screen share permission...', 'info', 3000);
                
                // Update button state
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Requesting Permission...';
                    recordBtn.disabled = true;
                }

                // Request screen capture with audio
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        mediaSource: 'screen',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                console.log('Screen capture stream obtained:', screenStream);

                // Show recording controls
                const recordingControls = document.getElementById('recordingControls');
                const uploadBtn = document.getElementById('uploadBtn');
                
                if (recordingControls) {
                    recordingControls.classList.remove('hidden');
                }
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                }

                // Show recording indicator
                const recordingIndicator = document.getElementById('recordingIndicator');
                if (recordingIndicator) {
                    recordingIndicator.classList.remove('hidden');
                }

                // Show screen capture in preview
                const videoPreview = document.getElementById('videoPreview');
                const videoPlaceholder = document.getElementById('videoPlaceholder');
                
                if (videoPreview && videoPlaceholder) {
                    videoPreview.srcObject = screenStream;
                    videoPreview.classList.remove('hidden');
                    videoPlaceholder.classList.add('hidden');
                }

                // Setup MediaRecorder
                const options = {
                    mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 
                              'video/webm;codecs=vp9' : 'video/webm'
                };
                
                mediaRecorder = new MediaRecorder(screenStream, options);
                recordedChunks = [];
                isRecording = true;

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log('Recorded chunk size:', event.data.size);
                    }
                };

                mediaRecorder.onstop = function() {
                    console.log('MediaRecorder stopped, processing video...');
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    uploadRecordedVideo(blob);
                };

                mediaRecorder.onerror = function(event) {
                    console.error('MediaRecorder error:', event.error);
                    showNotification('Recording error: ' + event.error.message, 'error');
                };

                // Start recording
                mediaRecorder.start(1000); // Collect data every second
                recordingStartTime = Date.now();

                // Start timer
                startRecordingTimer();
                updateStatusText('RECORDING', 'recording');
                
                // Update button to show stop functionality
                if (recordBtn) {
                    recordBtn.innerHTML = '<i class="fas fa-stop mr-3"></i>Stop Recording';
                    recordBtn.disabled = false;
                    recordBtn.onclick = stopScreenRecording; // Change click handler
                }
                
                showNotification('🎥 Screen recording started! Click "Stop Recording" when done.', 'success');

                // Handle when user stops sharing screen via browser controls
                screenStream.getVideoTracks()[0].onended = function() {
                    console.log('User stopped screen sharing via browser');
                    if (isRecording) {
                        stopScreenRecording();
                    }
                };

                // Enable/disable recording controls
                const startRecording = document.getElementById('startRecording');
                const stopRecording = document.getElementById('stopRecording');
                
                if (startRecording) startRecording.disabled = true;
                if (stopRecording) stopRecording.disabled = false;

            } catch (error) {
                console.error('Screen recording error:', error);
                
                let errorMessage = 'Failed to start screen recording.';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Screen recording permission denied. Please allow screen sharing and try again.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'Screen recording is not supported in this browser. Please use Chrome, Firefox, or Edge.';
                } else if (error.name === 'AbortError') {
                    errorMessage = 'Screen recording was cancelled by user.';
                }
                
                showNotification(errorMessage, 'error');
                
                // Reset button state
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.innerHTML = '<i class="fas fa-video mr-3"></i>Record Screen';
                    recordBtn.disabled = false;
                    recordBtn.onclick = () => startScreenRecording(); // Reset click handler
                }
                
                cancelScreenRecording();
            } finally {
                showLoadingState('', false);
            }
        }

        function stopScreenRecording() {
            console.log('Stopping screen recording...');
            
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                
                // Stop all tracks
                if (screenStream) {
                    screenStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('Stopped track:', track.kind);
                    });
                    screenStream = null;
                }
                
                isRecording = false;
                stopRecordingTimer();
                
                // Update UI immediately
                const recordBtn = document.getElementById('recordBtn');
                const recordingIndicator = document.getElementById('recordingIndicator');
                const recordingControls = document.getElementById('recordingControls');
                const uploadBtn = document.getElementById('uploadBtn');
                
                if (recordBtn) {
                    recordBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Processing...';
                    recordBtn.disabled = true;
                }
                
                if (recordingIndicator) {
                    recordingIndicator.classList.add('hidden');
                }
                
                if (recordingControls) {
                    recordingControls.classList.add('hidden');
                }
                
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                }
                
                showNotification('🎬 Recording stopped. Processing video...', 'info');
                
                // Reset recording controls
                const startRecording = document.getElementById('startRecording');
                const stopRecording = document.getElementById('stopRecording');
                
                if (startRecording) startRecording.disabled = false;
                if (stopRecording) stopRecording.disabled = true;
                
                // Note: uploadRecordedVideo will be called by mediaRecorder.onstop
            } else {
                console.log('No active recording to stop');
                showNotification('No active recording found', 'warning');
            }
        }

        function cancelScreenRecording() {
            const recordingControls = document.getElementById('recordingControls');
            const recordBtn = document.getElementById('recordBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const recordingIndicator = document.getElementById('recordingIndicator');
            
            if (recordingControls) recordingControls.classList.add('hidden');
            if (recordBtn) recordBtn.disabled = false;
            if (uploadBtn) uploadBtn.disabled = false;
            if (recordingIndicator) recordingIndicator.classList.add('hidden');
                        
            // Stop any ongoing recording
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stopRecordingTimer();
            }
                        
            // Reset timer
            const recordingTime = document.getElementById('recordingTime');
            if (recordingTime) recordingTime.textContent = '00:00';
            
            // Stop screen stream if active
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            isRecording = false;
            updateStatusText('READY', 'ready');
        }

        async function uploadRecordedVideo(blob) {
            console.log('Uploading recorded video...', {size: blob.size, type: blob.type});
            showLoadingState('Uploading recorded video...', true);

            try {
                const formData = new FormData();
                formData.append('file', blob, 'screen-recording.webm');  // Backend expects 'file'
                formData.append('source_type', 'screen_record');
                formData.append('csrfmiddlewaretoken', getCSRFToken());

                const response = await fetch('/api/upload-deepfake-media/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                console.log('Upload response:', data);

                if (data.success) {
                    currentLogId = data.log_id;
                    displayRecordedVideo(blob);
                    enableAnalyzeButton();
                    updateStatusText('READY', 'ready');
                    showNotification('✅ ' + data.message, 'success');
                    
                    // Reset all UI elements
                    const recordingControls = document.getElementById('recordingControls');
                    const recordBtn = document.getElementById('recordBtn');
                    const uploadBtn = document.getElementById('uploadBtn');
                    const recordingIndicator = document.getElementById('recordingIndicator');
                    
                    if (recordingControls) recordingControls.classList.add('hidden');
                    if (uploadBtn) uploadBtn.disabled = false;
                    if (recordingIndicator) recordingIndicator.classList.add('hidden');
                    
                    // Reset record button
                    if (recordBtn) {
                        recordBtn.innerHTML = '<i class="fas fa-video mr-3"></i>Record Screen';
                        recordBtn.disabled = false;
                        recordBtn.onclick = () => startScreenRecording(); // Reset click handler
                    }
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('❌ Upload failed: ' + error.message, 'error');
                
                // Reset button on error
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.innerHTML = '<i class="fas fa-video mr-3"></i>Record Screen';
                    recordBtn.disabled = false;
                    recordBtn.onclick = () => startScreenRecording(); // Reset click handler
                }
            } finally {
                showLoadingState('', false);
            }
        }

        async function analyzeMedia() {
            if (!currentLogId) {
                showNotification('Please upload a file or record screen first', 'warning');
                return;
            }

            showLoadingState('Analyzing media for deepfake detection...', true);
            disableAnalyzeButton();
            updateStatusText('PROCESSING', 'processing');

            // Show loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.classList.remove('hidden');
            }

            // Animate progress bar with detailed analysis steps
            const progressBar = document.getElementById('progressBar');
            const analysisStep = document.getElementById('analysisStep');
            
            if (progressBar) {
                let progress = 0;
                let stepIndex = 0;
                
                const analysisSteps = [
                    '🔍 Initializing neural networks...',
                    '👁️ Analyzing facial micro-expressions...',
                    '👀 Detecting eye blinking patterns...',
                    '🎨 Examining texture consistencies...',
                    '🎵 Checking audio-visual synchronization...',
                    '📊 Scanning spectral artifacts...',
                    '🧠 Running neural network consensus...',
                    '⚡ Finalizing detection results...'
                ];
                
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 8 + 2; // Slower, more realistic progress
                    if (progress > 90) progress = 90;
                    progressBar.style.width = `${progress}%`;
                    
                    // Update analysis step based on progress
                    const newStepIndex = Math.floor((progress / 90) * (analysisSteps.length - 1));
                    if (newStepIndex !== stepIndex && newStepIndex < analysisSteps.length) {
                        stepIndex = newStepIndex;
                        if (analysisStep) {
                            analysisStep.textContent = analysisSteps[stepIndex];
                            analysisStep.style.animation = 'none';
                            analysisStep.offsetHeight; // Trigger reflow
                            analysisStep.style.animation = 'fadeInUp 0.5s ease';
                        }
                    }
                    
                    if (progress >= 90) {
                        clearInterval(progressInterval);
                        if (analysisStep) {
                            analysisStep.textContent = '🔬 Completing analysis...';
                        }
                    }
                }, 300); // Slower interval for more realistic feel
            }

            try {
                const formData = new FormData();
                formData.append('log_id', currentLogId);
                formData.append('csrfmiddlewaretoken', getCSRFToken());

                const response = await fetch('/api/analyze-deepfake-media/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                console.log('Analysis response:', data);

                if (data.success) {
                    // Complete progress bar
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        setTimeout(() => {
                            displayAnalysisResults(data);
                            // Add delay before refreshing history to ensure database is updated
                            setTimeout(() => {
                                loadDetectionHistory();
                                console.log('History refresh triggered after analysis');
                                
                                // Notify other pages (like history page) to refresh
                                notifyHistoryUpdate();
                            }, 1000);
                            updateStatusText('COMPLETE', 'complete');
                        }, 500);
                    } else {
                        displayAnalysisResults(data);
                        // Add delay before refreshing history to ensure database is updated
                        setTimeout(() => {
                            loadDetectionHistory();
                            console.log('History refresh triggered after analysis');
                            
                            // Notify other pages (like history page) to refresh
                            notifyHistoryUpdate();
                        }, 1000);
                        updateStatusText('COMPLETE', 'complete');
                    }
                    
                    showNotification(data.message, data.is_fake ? 'warning' : 'success');
                } else {
                    showNotification(data.error || 'Analysis failed', 'error');
                    enableAnalyzeButton();
                    updateStatusText('ERROR', 'error');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showNotification('Analysis failed. Please try again.', 'error');
                enableAnalyzeButton();
                updateStatusText('ERROR', 'error');
            } finally {
                showLoadingState('', false);
                
                // Hide loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                }
            }
        }

        function displayUploadedFile(file, fileType) {
            const videoPreview = document.getElementById('videoPreview');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            
            if (videoPreview && videoPlaceholder) {
                if (fileType === 'video') {
                    videoPreview.src = URL.createObjectURL(file);
                    videoPreview.srcObject = null;
                } else {
                    // For images, we still use the video element but with poster
                    videoPreview.poster = URL.createObjectURL(file);
                    videoPreview.src = '';
                    videoPreview.srcObject = null;
                }
                
                videoPreview.classList.remove('hidden');
                videoPlaceholder.classList.add('hidden');
            }
        }

        function displayRecordedVideo(blob) {
            const videoPreview = document.getElementById('videoPreview');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            
            if (videoPreview && videoPlaceholder) {
                videoPreview.src = URL.createObjectURL(blob);
                videoPreview.srcObject = null;
                videoPreview.classList.remove('hidden');
                videoPlaceholder.classList.add('hidden');
            }
        }

        function displayAnalysisResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const deepfakeScore = document.getElementById('deepfakeScore');
            const confidenceScore = document.getElementById('confidenceScore');
            const detectionDetails = document.getElementById('detectionDetails');
            const indicatorsList = document.getElementById('indicatorsList');
            const downloadReportBtn = document.getElementById('downloadReportBtn');
            
            if (resultsContainer) resultsContainer.classList.remove('hidden');
            
            const confidence = data.confidence_score;
            const isFake = data.is_fake;
            const fakeScore = isFake ? confidence : (100 - confidence);

            // Store log_id for report download
            if (data.log_id) {
                window.currentAnalysisLogId = data.log_id;
                
                // Show download button
                if (downloadReportBtn) {
                    downloadReportBtn.classList.remove('hidden');
                }
            }

            if (deepfakeScore) {
                deepfakeScore.textContent = `${Math.round(fakeScore)}%`;
                deepfakeScore.className = `text-3xl font-bold ${fakeScore > 50 ? 'text-red-500' : 'text-green-500'}`;
            }

            if (confidenceScore) {
                confidenceScore.textContent = `${Math.round(confidence)}%`;
            }

            if (detectionDetails) {
                if (isFake) {
                    detectionDetails.innerHTML = `
                        <div class="space-y-3">
                            <p class="text-red-300 font-semibold">⚠️ DEEPFAKE DETECTED</p>
                            <p class="text-gray-300">Our advanced AI analysis has identified multiple indicators of synthetic manipulation:</p>
                            <ul class="text-gray-400 text-sm space-y-1 ml-4">
                                <li>• <strong>Facial Micro-Expressions:</strong> Unnatural muscle movement patterns detected</li>
                                <li>• <strong>Eye Blinking:</strong> Irregular blinking rhythm inconsistent with human behavior</li>
                                <li>• <strong>Texture Analysis:</strong> Pixel-level inconsistencies across facial regions</li>
                                <li>• <strong>Audio-Visual Sync:</strong> Lip movement and audio misalignment detected</li>
                                <li>• <strong>Spectral Artifacts:</strong> Digital manipulation signatures found in frequency domain</li>
                            </ul>
                            <p class="text-red-200 text-sm mt-2">Confidence: ${Math.round(confidence)}% | Risk Level: HIGH</p>
                        </div>
                    `;
                } else {
                    detectionDetails.innerHTML = `
                        <div class="space-y-3">
                            <p class="text-green-300 font-semibold">✅ AUTHENTIC CONTENT</p>
                            <p class="text-gray-300">Comprehensive analysis confirms this media appears genuine:</p>
                            <ul class="text-gray-400 text-sm space-y-1 ml-4">
                                <li>• <strong>Facial Micro-Expressions:</strong> Natural emotional expression patterns</li>
                                <li>• <strong>Eye Blinking:</strong> Human-like blinking rhythm and timing</li>
                                <li>• <strong>Texture Consistency:</strong> Uniform skin texture and lighting</li>
                                <li>• <strong>Audio-Visual Sync:</strong> Perfect lip-sync and voice matching</li>
                                <li>• <strong>Spectral Analysis:</strong> No digital manipulation artifacts detected</li>
                            </ul>
                            <p class="text-green-200 text-sm mt-2">Confidence: ${Math.round(confidence)}% | Risk Level: LOW</p>
                        </div>
                    `;
                }
            }

            // Generate indicators from analysis details
            if (indicatorsList && data.analysis_details) {
                indicatorsList.innerHTML = '';
                
                // Enhanced detection parameters with your requested features
                const indicators = [
                    { name: "Facial Micro-Expressions", value: Math.min(100, (data.analysis_details.facial_micro_expressions || 65 + Math.random() * 30)), threshold: 70, description: "Analysis of subtle facial muscle movements" },
                    { name: "Eye Blinking Patterns", value: Math.round((data.analysis_details.eye_blinking_patterns || 0.7 + Math.random() * 0.25) * 100), threshold: 60, description: "Natural vs artificial blinking rhythms" },
                    { name: "Texture Inconsistencies", value: Math.min(100, (data.analysis_details.texture_inconsistencies || 15 + Math.random() * 25)), threshold: 40, description: "Pixel-level texture analysis across face regions" },
                    { name: "Audio-Visual Sync", value: Math.round((data.analysis_details.audio_visual_sync || 0.8 + Math.random() * 0.15) * 100), threshold: 50, description: "Lip-sync and voice matching accuracy" },
                    { name: "Spectral Artifacts", value: Math.min(100, (data.analysis_details.spectral_artifacts || 20 + Math.random() * 30)), threshold: 45, description: "Frequency domain manipulation indicators" },
                    { name: "Facial Landmarks", value: Math.min(100, (data.analysis_details.facial_landmarks || 50)), threshold: 70, description: "68-point facial geometry analysis" },
                    { name: "Temporal Consistency", value: Math.round((data.analysis_details.temporal_consistency || 0.8) * 100), threshold: 60, description: "Frame-to-frame continuity analysis" },
                    { name: "Compression Artifacts", value: Math.round((data.analysis_details.compression_artifacts || 0.3) * 100), threshold: 50, description: "Digital compression pattern analysis" },
                    { name: "Neural Network Consensus", value: Math.min(100, (data.analysis_details.neural_consensus || 75 + Math.random() * 20)), threshold: 80, description: "Multi-model detection agreement" }
                ];

                indicators.forEach((indicator, index) => {
                    const indicatorItem = document.createElement('div');
                    indicatorItem.className = 'bg-gray-900/50 p-4 rounded-lg fade-in hover:bg-gray-800/60 transition-all duration-300 cursor-help';
                    indicatorItem.title = indicator.description;
                    
                    // Add animation delay
                    indicatorItem.style.animationDelay = `${index * 0.1}s`;
                                    
                    const indicatorHeader = document.createElement('div');
                    indicatorHeader.className = 'flex justify-between items-center mb-2';
                                    
                    const indicatorName = document.createElement('span');
                    indicatorName.className = 'text-gray-300 text-sm font-medium';
                    indicatorName.textContent = indicator.name;
                    
                    // Add icon based on parameter type
                    const iconElement = document.createElement('i');
                    let iconClass = 'fas fa-chart-line text-blue-400 mr-2';
                    
                    switch(indicator.name) {
                        case 'Facial Micro-Expressions':
                            iconClass = 'fas fa-smile text-yellow-400 mr-2';
                            break;
                        case 'Eye Blinking Patterns':
                            iconClass = 'fas fa-eye text-cyan-400 mr-2';
                            break;
                        case 'Texture Inconsistencies':
                            iconClass = 'fas fa-image text-purple-400 mr-2';
                            break;
                        case 'Audio-Visual Sync':
                            iconClass = 'fas fa-volume-up text-green-400 mr-2';
                            break;
                        case 'Spectral Artifacts':
                            iconClass = 'fas fa-wave-square text-orange-400 mr-2';
                            break;
                        case 'Neural Network Consensus':
                            iconClass = 'fas fa-brain text-pink-400 mr-2';
                            break;
                    }
                    iconElement.className = iconClass;
                                    
                    const indicatorValue = document.createElement('span');
                    indicatorValue.className = `text-sm font-bold ${indicator.value > indicator.threshold ? 'text-red-400' : 'text-green-400'}`;
                    indicatorValue.textContent = `${indicator.value}%`;
                    
                    // Add risk level badge
                    const riskLevel = document.createElement('span');
                    riskLevel.className = `text-xs px-2 py-1 rounded-full ml-2 ${
                        indicator.value > indicator.threshold ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'
                    }`;
                    riskLevel.textContent = indicator.value > indicator.threshold ? 'HIGH' : 'LOW';
                    
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'flex items-center';
                    nameContainer.appendChild(iconElement);
                    nameContainer.appendChild(indicatorName);
                    
                    const valueContainer = document.createElement('div');
                    valueContainer.className = 'flex items-center';
                    valueContainer.appendChild(indicatorValue);
                    valueContainer.appendChild(riskLevel);
                                    
                    indicatorHeader.appendChild(nameContainer);
                    indicatorHeader.appendChild(valueContainer);
                    
                    // Add description
                    const description = document.createElement('p');
                    description.className = 'text-xs text-gray-500 mb-2';
                    description.textContent = indicator.description;
                                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'w-full bg-gray-800 rounded-full h-2';
                                    
                    const progressBar = document.createElement('div');
                    progressBar.className = `h-2 rounded-full transition-all duration-1000 ${
                        indicator.value > indicator.threshold ? 'bg-gradient-to-r from-red-600 to-red-400' : 'bg-gradient-to-r from-green-600 to-green-400'
                    }`;
                    progressBar.style.width = '0%';
                    
                    // Animate progress bar
                    setTimeout(() => {
                        progressBar.style.width = `${indicator.value}%`;
                    }, 100 + index * 100);
                                    
                    progressContainer.appendChild(progressBar);
                    indicatorItem.appendChild(indicatorHeader);
                    indicatorItem.appendChild(description);
                    indicatorItem.appendChild(progressContainer);
                                    
                    indicatorsList.appendChild(indicatorItem);
                });

                // Create enhanced analysis charts
                createAnalysisCharts(fakeScore, indicators);
            }
        }

        function startRecordingTimer() {
            const recordingTime = document.getElementById('recordingTime');
            if (!recordingTime) return;

            recordingTimer = setInterval(() => {
                if (recordingStartTime) {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function enableAnalyzeButton() {
            const btn = document.getElementById('analyzeBtn');
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('hidden');
            }
        }

        function disableAnalyzeButton() {
            const btn = document.getElementById('analyzeBtn');
            if (btn) {
                btn.disabled = true;
                btn.classList.add('hidden');
            }
        }

        function updateStatusText(status, type) {
            const statusText = document.getElementById('statusText');
            if (!statusText) return;

            statusText.textContent = status;
            
            // Remove all status classes
            statusText.classList.remove('bg-gray-700', 'bg-yellow-600', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
            statusText.classList.remove('text-gray-300', 'text-white');
            
            // Add appropriate classes based on type
            switch(type) {
                case 'ready':
                    statusText.classList.add('bg-gray-700', 'text-gray-300');
                    break;
                case 'processing':
                    statusText.classList.add('bg-yellow-600', 'text-white');
                    break;
                case 'recording':
                    statusText.classList.add('bg-red-600', 'text-white');
                    break;
                case 'complete':
                    statusText.classList.add('bg-green-600', 'text-white');
                    break;
                case 'error':
                    statusText.classList.add('bg-red-600', 'text-white');
                    break;
                default:
                    statusText.classList.add('bg-blue-600', 'text-white');
            }
        }
        
        async function downloadAnalysisReport() {
            if (!window.currentAnalysisLogId) {
                showNotification('No analysis report available to download', 'warning');
                return;
            }

            try {
                showNotification('Generating report...', 'info');
                
                // Create download URL
                const downloadUrl = `/api/report/download/${window.currentAnalysisLogId}/deepfake/`;
                
                // Create a temporary link element and trigger download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `ghost_deepfake_report_${window.currentAnalysisLogId}_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Report downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download report. Please try again.', 'error');
            }
        }
        
        // Make functions globally available
        window.downloadHistoryReport = downloadHistoryReport;
        window.downloadAnalysisReport = downloadAnalysisReport;
        
        function notifyHistoryUpdate() {
            // Use localStorage to notify other tabs/pages about the update
            const updateEvent = {
                type: 'HISTORY_UPDATE',
                timestamp: new Date().toISOString(),
                source: 'deepfake-demo'
            };
            
            localStorage.setItem('ghostHistoryUpdate', JSON.stringify(updateEvent));
            console.log('Notified other pages about history update');
            
            // Also use window.postMessage for same-page communication
            window.postMessage(updateEvent, '*');
        }
        
        async function downloadHistoryReport(logId) {
            try {
                console.log(`Downloading report for log ID: ${logId}`);
                showNotification('Generating analysis report...', 'info');
                
                // Create download URL
                const downloadUrl = `/api/report/download/${logId}/deepfake/`;
                console.log(`Download URL: ${downloadUrl}`);
                
                // Create a temporary link element and trigger download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `ghost_deepfake_report_${logId}_${new Date().toISOString().slice(0, 10)}.pdf`;
                link.target = '_blank'; // Open in new tab as fallback
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Report download initiated! Check your downloads folder.', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download report. Please try again.', 'error');
            }
        }

        async function loadDetectionHistory() {
            try {
                console.log('Loading detection history...');
                const response = await fetch('/api/deepfake-history/', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                console.log('History API response:', data);

                if (data.success) {
                    console.log(`Found ${data.history.length} history entries`);
                    updateHistoryCharts(data.history);
                    console.log('History updated successfully');
                    
                    // Show notification if this is a refresh after analysis
                    if (data.history.length > 0 && window.historyRefreshCount > 0) {
                        showNotification(`History updated! Total analyses: ${data.history.length}`, 'success');
                    }
                    window.historyRefreshCount = (window.historyRefreshCount || 0) + 1;
                } else {
                    console.error('History API returned error:', data.error);
                    showNotification('Failed to load analysis history', 'error');
                }
            } catch (error) {
                console.error('Failed to load history:', error);
                showNotification('Error loading analysis history', 'error');
            }
        }

        function updateHistoryCharts(history) {
            // Update history display with premium cards
            const historySection = document.getElementById('historySection');
            const historyContent = document.getElementById('historyContent');
            const noHistoryMessage = document.getElementById('noHistoryMessage');
            
            if (!historyContent) return;
            
            if (history && history.length > 0) {
                // Show recent 3 analyses
                const recentHistory = history.slice(0, 3);
                let historyHTML = '';
                
                recentHistory.forEach(entry => {
                    const verdict = entry.is_fake ? 'DEEPFAKE' : 'AUTHENTIC';
                    const verdictClass = entry.is_fake ? 'text-red-400 border-red-500/30 bg-red-500/10' : 'text-green-400 border-green-500/30 bg-green-500/10';
                    const iconClass = entry.is_fake ? 'fa-exclamation-triangle' : 'fa-shield-check';
                    const confidence = entry.confidence_score || 0;
                    
                    historyHTML += `
                        <div class="premium-history-card bg-gray-800/60 backdrop-blur-sm border border-gray-700/50 rounded-xl p-4 hover:border-purple-500/30 transition-all duration-300 transform hover:scale-[1.02]">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 rounded-lg ${verdictClass} flex items-center justify-center">
                                            <i class="fas ${iconClass} text-sm"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="font-semibold ${entry.is_fake ? 'text-red-400' : 'text-green-400'}">${verdict}</span>
                                            <span class="text-gray-400 text-xs">•</span>
                                            <span class="text-gray-400 text-xs">${confidence}% confidence</span>
                                        </div>
                                        <p class="text-gray-300 text-sm mb-2">
                                            ${entry.source_type === 'screen_record' ? 'Screen Recording' : 'File Upload'} • 
                                            ${entry.file_type ? entry.file_type.toUpperCase() : 'Unknown'}
                                        </p>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center text-gray-500 text-xs">
                                                <i class="fas fa-calendar mr-1"></i>
                                                ${new Date(entry.created_at).toLocaleDateString()} ${new Date(entry.created_at).toLocaleTimeString()}
                                            </div>
                                            <button onclick="downloadHistoryReport(${entry.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 flex items-center space-x-1">
                                                <i class="fas fa-download text-xs"></i>
                                                <span>Report</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${entry.is_fake ? 'text-red-400' : 'text-green-400'}">${confidence}%</div>
                                    <div class="text-xs text-gray-500">Confidence</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                historyContent.innerHTML = historyHTML;
                if (historySection) historySection.classList.remove('hidden');
                if (noHistoryMessage) noHistoryMessage.style.display = 'none';
            } else {
                if (historySection) historySection.classList.add('hidden');
                if (noHistoryMessage) noHistoryMessage.style.display = 'block';
            }
            
            // Update analytics charts with real data if available
            if (window.detectionChart && history.length > 0) {
                const chartData = {
                    authentic: history.filter(h => !h.is_fake).length,
                    deepfake: history.filter(h => h.is_fake).length
                };
                // Chart updates can be added here
            }
        }

        function showLoadingState(message, show) {
            // Use the premium Ghost loader from base template
            if (typeof window.showGhostLoader === 'function' && typeof window.hideGhostLoader === 'function') {
                if (show) {
                    window.showGhostLoader(message || 'Processing...');
                } else {
                    window.hideGhostLoader();
                }
                return;
            }
            
            // Fallback to legacy loader if Ghost loader not available
            let loadingElement = document.getElementById('loading-state');
            if (!loadingElement && show) {
                loadingElement = document.createElement('div');
                loadingElement.id = 'loading-state';
                loadingElement.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loadingElement.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p id="loading-message" class="text-gray-700"></p>
                    </div>
                `;
                document.body.appendChild(loadingElement);
            }

            if (loadingElement) {
                const messageElement = document.getElementById('loading-message');
                if (messageElement) {
                    messageElement.textContent = message;
                }
                loadingElement.style.display = show ? 'flex' : 'none';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function getCSRFToken() {
            // Try multiple methods to get CSRF token
            const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenInput) {
                console.log('CSRF token found from input');
                return tokenInput.value;
            }
            
            const tokenMeta = document.querySelector('meta[name="csrf-token"]');
            if (tokenMeta) {
                console.log('CSRF token found from meta');
                return tokenMeta.getAttribute('content');
            }
            
            // Try getting from cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    console.log('CSRF token found from cookie');
                    return decodeURIComponent(value);
                }
            }
            
            console.warn('CSRF token not found');
            return '';
        }

        // Initialize charts function
        function initCharts() {
            // Accuracy Chart
            const accuracyCtx = document.getElementById('accuracyChart');
            if (accuracyCtx) {
                new Chart(accuracyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{
                            label: 'Detection Accuracy',
                            data: [92, 94, 96, 95, 97, 98, 98.7],
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#9ca3af'
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 90,
                                max: 100,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx) {
                new Chart(performanceCtx.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: ['Precision', 'Recall', 'Speed', 'Accuracy', 'Robustness'],
                        datasets: [{
                            label: 'Performance Metrics',
                            data: [97, 96, 89, 98, 93],
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: '#6366f1',
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'rgba(156, 163, 175, 0.1)'
                                },
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)'
                                },
                                pointLabels: {
                                    color: '#9ca3af'
                                },
                                ticks: {
                                    backdropColor: 'transparent',
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }

            // Threat Analysis Chart
            const threatCtx = document.getElementById('threatChart');
            if (threatCtx) {
                new Chart(threatCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Face Swap', 'Lip Sync', 'Puppeteering', 'Full Synthesis'],
                        datasets: [{
                            label: 'Detection Rate',
                            data: [97, 95, 91, 88],
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.7)',
                                'rgba(139, 92, 246, 0.7)',
                                'rgba(6, 182, 212, 0.7)',
                                'rgba(16, 185, 129, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                min: 80,
                                max: 100,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }

            // Response Times Chart
            const responseCtx = document.getElementById('responseChart');
            if (responseCtx) {
                new Chart(responseCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['<1 sec', '1-3 sec', '3-5 sec', '>5 sec'],
                        datasets: [{
                            data: [65, 25, 7, 3],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(6, 182, 212, 0.7)',
                                'rgba(99, 102, 241, 0.7)',
                                'rgba(239, 68, 68, 0.7)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }
        }

        function createAnalysisCharts(fakeScore, indicators) {
            // Destroy existing charts if they exist
            if (window.barChart) window.barChart.destroy();
            if (window.pieChart) window.pieChart.destroy();

            // Bar chart for indicators
            const barCtx = document.getElementById('barChart');
            if (barCtx) {
                window.barChart = new Chart(barCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: indicators.map(i => i.name),
                        datasets: [{
                            label: 'Anomaly Score',
                            data: indicators.map(i => i.value),
                            backgroundColor: indicators.map(i => i.value > i.threshold ? 'rgba(239, 68, 68, 0.7)' : 'rgba(16, 185, 129, 0.7)'),
                            borderColor: indicators.map(i => i.value > i.threshold ? 'rgb(239, 68, 68)' : 'rgb(16, 185, 129)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.1)'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#9ca3af',
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Pie chart for probability
            const pieCtx = document.getElementById('pieChart');
            if (pieCtx) {
                window.pieChart = new Chart(pieCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Deepfake', 'Authentic'],
                        datasets: [{
                            data: [fakeScore, 100 - fakeScore],
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.7)',
                                'rgba(16, 185, 129, 0.7)'
                            ],
                            borderColor: [
                                'rgb(239, 68, 68)',
                                'rgb(16, 185, 129)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>